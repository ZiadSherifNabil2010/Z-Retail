{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-boxes"></i> Products Management</h2>
        <button type="button" class="btn btn-success btn-lg" data-toggle="modal" data-target="#addProductModal">
            <i class="fas fa-plus"></i> Add New Product
        </button>
    </div>
    
    <!-- Filters Section -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="fas fa-filter"></i> Filters & Search</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label><i class="fas fa-search"></i> Search Products</label>
                        <input type="text" id="searchInput" class="form-control" placeholder="Search by name, SKU, or ISBN...">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label><i class="fas fa-tags"></i> Search Categories</label>
                        <input type="text" id="categorySearch" class="form-control" placeholder="Type to search categories...">
                        <div id="categoryDropdown" class="dropdown-menu search-dropdown" style="display: none; position: absolute; width: 100%; max-height: 200px; overflow-y: auto; z-index: 1000;">
                            <div class="dropdown-item" data-value="">All Categories</div>
                            {% for category in categories %}
                            <div class="dropdown-item" data-value="{{ category.nameAr }}">{{ category.nameAr }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label><i class="fas fa-building"></i> Search Departments</label>
                        <input type="text" id="departmentSearch" class="form-control" placeholder="Type to search departments...">
                        <div id="departmentDropdown" class="dropdown-menu search-dropdown" style="display: none; position: absolute; width: 100%; max-height: 200px; overflow-y: auto; z-index: 1000;">
                            <div class="dropdown-item" data-value="">All Departments</div>
                            {% for department in departments %}
                            <div class="dropdown-item" data-value="{{ department.name }}">{{ department.name }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label><i class="fas fa-dollar-sign"></i> Filter by Price</label>
                        <select id="priceFilter" class="form-control">
                            <option value="">All Prices</option>
                            <option value="0-50">0 - 50 EGP</option>
                            <option value="51-100">51 - 100 EGP</option>
                            <option value="101-500">101 - 500 EGP</option>
                            <option value="500+">500+ EGP</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <button class="btn btn-secondary" onclick="clearFilters()">
                        <i class="fas fa-times"></i> Clear Filters
                    </button>
                    <span id="resultsCount" class="ml-3 text-muted"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Table -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-list"></i> Products List</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="productsTable">
                    <thead class="thead-dark">
                        <tr>
                            <th><i class="fas fa-barcode"></i> SKU</th>
                            <th><i class="fas fa-box"></i> Item Name</th>
                            <th><i class="fas fa-book"></i> ISBN</th>
                            <th><i class="fas fa-tags"></i> Category</th>
                            <th><i class="fas fa-building"></i> Department</th>
                            <th><i class="fas fa-dollar-sign"></i> Sales Price</th>
                            <th><i class="fas fa-percent"></i> VAT</th>
                            <th><i class="fas fa-cogs"></i> Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        {% for product in products %}
                        <!-- Fixed table row with better ISBN handling -->
<tr class="product-row" 
data-name="{{ product.get('Item Name', product.get('item_name', '')) }}" 
data-sku="{{ product.get('sku', '') }}" 
data-isbn="{{ product.get('ISBN', product.get('isbn', '')) }}"
data-category="{{ product.get('Category Dropdown', product.get('category', '')) }}"
data-department="{{ product.get('Department Dropdown', product.get('department', '')) }}"
data-price="{{ product.get('Sales Price Includ Tax', product.get('sales_price', 0)) }}">

<td><span class="badge-primary badge-pill">{{ product.get('sku', 'N/A') }}</span></td>
<td><strong>{{ product.get('Item Name', product.get('item_name', 'N/A')) }}</strong></td>
<td>{{ product.get('ISBN', product.get('isbn', 'N/A')) }}</td>
<td><span>{{ product.get('Category Dropdown', product.get('category', 'N/A')) }}</span></td>
<td><span>{{ product.get('Department Dropdown', product.get('department', 'N/A')) }}</span></td>
<td><span class="text-success font-weight-bold">{{ "%.2f"|format(product.get('Sales Price Includ Tax', product.get('sales_price', 0))|float) }} EGP</span></td>
<td>{{ product.get('Vat', product.get('vat', 0)) }} EGP</td>
<td>
    <div class="btn-group" role="group">
        {% set product_isbn = product.get('ISBN', product.get('isbn', '')) %}
        {% set product_name = product.get('Item Name', product.get('item_name', 'Unknown Product')) %}
        
        <!-- Debug info (remove in production) -->
        <!-- Product ISBN: {{ product_isbn }} -->
        
        {% if product_isbn %}
            <button class="btn btn-sm btn-outline-primary" 
                    onclick="editProduct('{{ product_isbn|e }}')" 
                    title="Edit Product">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" 
                    onclick="deleteProduct('{{ product_isbn|e }}', '{{ product_name|e }}')" 
                    title="Delete Product">
                <i class="fas fa-trash"></i>
            </button>
        {% else %}
            <!-- Fallback to SKU if ISBN is not available -->
            {% set product_sku = product.get('sku', product.get('SKU', '')) %}
            {% if product_sku %}
                <button class="btn btn-sm btn-outline-primary" 
                        onclick="editProduct('{{ product_sku|e }}')" 
                        title="Edit Product">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" 
                        onclick="deleteProduct('{{ product_sku|e }}', '{{ product_name|e }}')" 
                        title="Delete Product">
                    <i class="fas fa-trash"></i>
                </button>
            {% else %}
                <!-- No valid identifier found -->
                <button class="btn btn-sm btn-outline-secondary" 
                        disabled
                        title="No valid identifier found">
                    <i class="fas fa-exclamation-triangle"></i>
                </button>
            {% endif %}
        {% endif %}
    </div>
</td>
</tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div id="noResultsMessage" class="text-center text-muted py-4" style="display: none;">
                <i class="fas fa-search fa-3x mb-3"></i>
                <h5>No products found</h5>
                <p>Try adjusting your search criteria or filters.</p>
            </div>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Add New Product</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Debug Info (remove this in production) -->
                <div class="alert alert-info" style="display: none;" id="debugInfo">
                    <strong>Debug Info:</strong><br>
                    Categories count: {{ categories|length }}<br>
                    Departments count: {{ departments|length }}<br>
                    {% if categories %}
                        First category: {{ categories[0] }}<br>
                    {% endif %}
                    {% if departments %}
                        First department: {{ departments[0] }}<br>
                    {% endif %}
                </div>
                
                <form id="addProductForm" action="{{ url_for('add_product') }}" method="POST">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-box"></i> Item Name *</label>
                                <input type="text" class="form-control" name="item_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-book"></i> ISBN *</label>
                                <input type="text" class="form-control" name="isbn" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-barcode"></i> SKU *</label>
                                <input type="text" class="form-control" name="sku" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-tags"></i> Category *</label>
                                <select class="form-control select2" name="category" required>
                                    <option value="">Select Category</option>
                                    {% if categories %}
                                        {% for category in categories %}
                                            {% if category.nameAr %}
                                                <option value="{{ category.nameAr }}">{{ category.nameAr }}</option>
                                            {% elif category.name %}
                                                <option value="{{ category.name }}">{{ category.name }}</option>
                                            {% elif category %}
                                                <option value="{{ category }}">{{ category }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <option value="General">General</option>
                                        <option value="Electronics">Electronics</option>
                                        <option value="Clothing">Clothing</option>
                                    {% endif %}
                                </select>
                                {% if not categories %}
                                    <small class="text-warning">No categories loaded from database. Using defaults.</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-building"></i> Department *</label>
                                <select class="form-control select2" name="department" required>
                                    <option value="">Select Department</option>
                                    {% if departments %}
                                        {% for department in departments %}
                                            {% if department.name %}
                                                <option value="{{ department.name }}">{{ department.name }}</option>
                                            {% elif department %}
                                                <option value="{{ department }}">{{ department }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <option value="General">General</option>
                                        <option value="Electronics">Electronics</option>
                                        <option value="Clothing">Clothing</option>
                                    {% endif %}
                                </select>
                                {% if not departments %}
                                    <small class="text-warning">No departments loaded from database. Using defaults.</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-dollar-sign"></i> Sales Price (Including Tax) *</label>
                                <input type="number" step="0.01" class="form-control" name="sales_price" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-percent"></i> VAT *</label>
                                <input type="number" step="0.01" class="form-control" name="vat" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><i class="fas fa-cube"></i> Unit *</label>
                                <select class="form-control" name="unit" required>
                                    <option value="">Select Unit</option>
                                    <option value="piece">Piece</option>
                                    <option value="kg">Kilogram</option>
                                    <option value="liter">Liter</option>
                                    <option value="meter">Meter</option>
                                    <option value="box">Box</option>
                                    <option value="pack">Pack</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" form="addProductForm" class="btn btn-success">
                    <i class="fas fa-plus"></i> Add Product
                </button>
                <button type="button" class="btn btn-info btn-sm" onclick="toggleDebug()" style="margin-left: 10px;">
                    <i class="fas fa-bug"></i> Debug
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function toggleDebug() {
    var debugInfo = document.getElementById('debugInfo');
    if (debugInfo.style.display === 'none') {
        debugInfo.style.display = 'block';
    } else {
        debugInfo.style.display = 'none';
    }
}

// Add some debugging to console
console.log('Categories:', {{ categories|tojson }});
console.log('Departments:', {{ departments|tojson }});
</script>

<!-- Edit Product Modal - ENLARGED VERSION -->
<div class="modal fade" id="editProductModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document" style="max-width: 90%; margin: 30px auto;">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white" style="padding: 25px 30px;">
                <h4 class="modal-title" style="font-size: 1.5rem;"><i class="fas fa-edit"></i> Edit Product</h4>
                <button type="button" class="close text-white" data-dismiss="modal" style="font-size: 2rem;">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 30px 40px;">
                <form id="editProductForm" method="POST">
                    <input type="hidden" name="isbn" id="editProductIsbn">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group" style="margin-bottom: 25px;">
                                <label style="font-size: 1.1rem; margin-bottom: 10px;"><i class="fas fa-box"></i> Item Name *</label>
                                <input type="text" class="form-control" name="item_name" required style="height: 50px; font-size: 1rem; padding: 15px;">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group" style="margin-bottom: 25px;">
                                <label style="font-size: 1.1rem; margin-bottom: 10px;"><i class="fas fa-barcode"></i> SKU *</label>
                                <input type="text" class="form-control" name="sku" required style="height: 50px; font-size: 1rem; padding: 15px;">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group" style="margin-bottom: 25px;">
                                <label style="font-size: 1.1rem; margin-bottom: 10px;"><i class="fas fa-book"></i> ISBN *</label>
                                <input type="text" class="form-control" name="isbn" required style="height: 50px; font-size: 1rem; padding: 15px;" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group" style="margin-bottom: 25px;">
                                <label style="font-size: 1.1rem; margin-bottom: 10px;"><i class="fas fa-tags"></i> Category *</label>
                                <select class="form-control select2" name="category" required style="height: 50px; font-size: 1rem;">
                                    {% for category in categories %}
                                    <option value="{{ category.nameAr }}">{{ category.nameAr }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group" style="margin-bottom: 25px;">
                                <label style="font-size: 1.1rem; margin-bottom: 10px;"><i class="fas fa-building"></i> Department *</label>
                                <select class="form-control select2" name="department" required style="height: 50px; font-size: 1rem;">
                                    {% for department in departments %}
                                    <option value="{{ department.name }}">{{ department.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group" style="margin-bottom: 25px;">
                                <label style="font-size: 1.1rem; margin-bottom: 10px;"><i class="fas fa-dollar-sign"></i> Sales Price (Including Tax) *</label>
                                <input type="number" step="0.01" class="form-control" name="sales_price" required style="height: 50px; font-size: 1rem; padding: 15px;">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group" style="margin-bottom: 25px;">
                                <label style="font-size: 1.1rem; margin-bottom: 10px;"><i class="fas fa-percent"></i> VAT *</label>
                                <input type="number" step="0.01" class="form-control" name="vat" required style="height: 50px; font-size: 1rem; padding: 15px;">
                            </div>
                        </div>

                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 25px 30px;">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()" style="font-size: 1.1rem; padding: 12px 25px; margin-right: 15px;">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" form="editProductForm" class="btn btn-primary" style="font-size: 1.1rem; padding: 12px 25px;">
                    <i class="fas fa-save"></i> Update Product
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Include SweetAlert2 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.3/sweetalert2.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.3/sweetalert2.min.css">

<!-- Include Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- Add these in the head section or before closing body tag -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    // Product data for JavaScript operations
    const products = {{ products|tojson }};
    
    // Global variables for selected filters
    let selectedCategory = '';
    let selectedDepartment = '';
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        updateResultsCount();
        setupEventListeners();
        setupSearchDropdowns();
    });
    
    // Setup event listeners for filters
    function setupEventListeners() {
        document.getElementById('searchInput').addEventListener('input', filterProducts);
        document.getElementById('priceFilter').addEventListener('change', filterProducts);
    }
    
    // Setup search dropdowns for categories and departments
    function setupSearchDropdowns() {
        // Category search setup
        const categorySearch = document.getElementById('categorySearch');
        const categoryDropdown = document.getElementById('categoryDropdown');
        
        categorySearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const items = categoryDropdown.querySelectorAll('.dropdown-item');
            let hasVisibleItems = false;
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                    hasVisibleItems = true;
                } else {
                    item.style.display = 'none';
                }
            });
            
            categoryDropdown.style.display = hasVisibleItems ? 'block' : 'none';
        });
        
        categorySearch.addEventListener('focus', function() {
            categoryDropdown.style.display = 'block';
        });
        
        // Category dropdown item click
        categoryDropdown.addEventListener('click', function(e) {
            if (e.target.classList.contains('dropdown-item')) {
                const value = e.target.getAttribute('data-value');
                const text = e.target.textContent;
                categorySearch.value = text;
                selectedCategory = value;
                categoryDropdown.style.display = 'none';
                filterProducts();
            }
        });
        
        // Department search setup
        const departmentSearch = document.getElementById('departmentSearch');
        const departmentDropdown = document.getElementById('departmentDropdown');
        
        departmentSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const items = departmentDropdown.querySelectorAll('.dropdown-item');
            let hasVisibleItems = false;
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                    hasVisibleItems = true;
                } else {
                    item.style.display = 'none';
                }
            });
            
            departmentDropdown.style.display = hasVisibleItems ? 'block' : 'none';
        });
        
        departmentSearch.addEventListener('focus', function() {
            departmentDropdown.style.display = 'block';
        });
        
        // Department dropdown item click
        departmentDropdown.addEventListener('click', function(e) {
            if (e.target.classList.contains('dropdown-item')) {
                const value = e.target.getAttribute('data-value');
                const text = e.target.textContent;
                departmentSearch.value = text;
                selectedDepartment = value;
                departmentDropdown.style.display = 'none';
                filterProducts();
            }
        });
        
        // Hide dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#categorySearch') && !e.target.closest('#categoryDropdown')) {
                categoryDropdown.style.display = 'none';
            }
            if (!e.target.closest('#departmentSearch') && !e.target.closest('#departmentDropdown')) {
                departmentDropdown.style.display = 'none';
            }
        });
    }
    
    // Filter products based on search and filter criteria
    function filterProducts() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const priceFilter = document.getElementById('priceFilter').value;
        
        const rows = document.querySelectorAll('.product-row');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const name = row.dataset.name.toLowerCase();
            const sku = row.dataset.sku.toLowerCase();
            const isbn = row.dataset.isbn.toLowerCase();
            const category = row.dataset.category;
            const department = row.dataset.department;
            const price = parseFloat(row.dataset.price);
            
            // Search filter
            const matchesSearch = searchTerm === '' || 
                name.includes(searchTerm) || 
                sku.includes(searchTerm) || 
                isbn.includes(searchTerm);
            
            // Category filter
            const matchesCategory = selectedCategory === '' || category === selectedCategory;
            
            // Department filter
            const matchesDepartment = selectedDepartment === '' || department === selectedDepartment;
            
            // Price filter
            let matchesPrice = true;
            if (priceFilter) {
                switch(priceFilter) {
                    case '0-50':
                        matchesPrice = price >= 0 && price <= 50;
                        break;
                    case '51-100':
                        matchesPrice = price >= 51 && price <= 100;
                        break;
                    case '101-500':
                        matchesPrice = price >= 101 && price <= 500;
                        break;
                    case '500+':
                        matchesPrice = price > 500;
                        break;
                }
            }
            
            // Show/hide row based on all filters
            if (matchesSearch && matchesCategory && matchesDepartment && matchesPrice) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Show/hide no results message
        const noResultsMessage = document.getElementById('noResultsMessage');
        const tableBody = document.getElementById('productsTableBody');
        
        if (visibleCount === 0) {
            noResultsMessage.style.display = 'block';
            tableBody.style.display = 'none';
        } else {
            noResultsMessage.style.display = 'none';
            tableBody.style.display = '';
        }
        
        updateResultsCount(visibleCount);
    }
    
    // Update results count
    function updateResultsCount(visibleCount = null) {
        const totalCount = document.querySelectorAll('.product-row').length;
        const displayCount = visibleCount !== null ? visibleCount : totalCount;
        
        document.getElementById('resultsCount').textContent = 
            `Showing ${displayCount} of ${totalCount} products`;
    }
    
    // Clear all filters
    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('categorySearch').value = '';
        document.getElementById('departmentSearch').value = '';
        document.getElementById('priceFilter').value = '';
        
        selectedCategory = '';
        selectedDepartment = '';
        
        // Hide dropdowns
        document.getElementById('categoryDropdown').style.display = 'none';
        document.getElementById('departmentDropdown').style.display = 'none';
        
        filterProducts();
        
        Swal.fire({
            icon: 'info',
            title: 'Filters Cleared',
            text: 'All filters have been reset',
            timer: 1500,
            showConfirmButton: false
        });
    }
   // Fixed editProduct function with better ISBN handling and debugging
function editProduct(isbn) {
    console.log('Starting editProduct function with ISBN:', isbn);
    
    // Validate ISBN parameter
    if (!isbn || isbn.trim() === '') {
        console.error('No ISBN provided to editProduct function');
        Swal.fire({
            icon: 'error',
            title: 'Invalid Product',
            text: 'No product identifier provided. Please try again.'
        });
        return;
    }
    
    if (!products || !Array.isArray(products)) {
        console.error('Products data is invalid:', products);
        Swal.fire({
            icon: 'error',
            title: 'Data Error',
            text: 'Product data is not properly loaded. Please refresh the page and try again.'
        });
        return;
    }
    
    // Find the product using the ISBN with multiple fallback approaches
    let productData = null;
    const searchIsbn = String(isbn).trim();
    
    // Try different approaches to find the product
    console.log('Searching for product with ISBN:', searchIsbn);
    console.log('Available products:', products.length);
    
    // Approach 1: Direct match
    productData = products.find(p => {
        if (!p) return false;
        const productIsbn = String(p.ISBN || p.isbn || '').trim();
        return productIsbn === searchIsbn;
    });
    
    // Approach 2: Case-insensitive match if first approach fails
    if (!productData) {
        productData = products.find(p => {
            if (!p) return false;
            const productIsbn = String(p.ISBN || p.isbn || '').trim().toLowerCase();
            return productIsbn === searchIsbn.toLowerCase();
        });
    }
    
    // Approach 3: Try to find by other identifiers if ISBN fails
    if (!productData) {
        console.warn('Product not found by ISBN, trying by SKU...');
        productData = products.find(p => {
            if (!p) return false;
            const productSku = String(p.sku || p.SKU || '').trim();
            return productSku === searchIsbn;
        });
    }
    
    if (!productData) {
        console.error('Product not found for ISBN:', searchIsbn);
        console.log('Available ISBNs in products:', products.map(p => p?.ISBN || p?.isbn || 'N/A'));
        
        Swal.fire({
            icon: 'error',
            title: 'Product Not Found',
            html: `
                <p>No product found with identifier: <strong>${searchIsbn}</strong></p>
                <p class="text-muted small">Please verify the product exists and try again.</p>
            `
        });
        return;
    }
    
    console.log('Found product:', productData);
    
    const form = document.getElementById('editProductForm');
    if (!form) {
        console.error('Edit form not found in DOM');
        Swal.fire({
            icon: 'error',
            title: 'Form Error',
            text: 'Could not find the edit form. Please refresh the page and try again.'
        });
        return;
    }
    
    // Use the actual ISBN from the found product data (not the search parameter)
    const actualIsbn = productData.ISBN || productData.isbn || searchIsbn;
    console.log('Using actual ISBN for form action:', actualIsbn);
    
    // Set the form action with the actual ISBN
    form.action = `/edit_product/${encodeURIComponent(actualIsbn)}`;
    
    try {
        // Set the hidden ISBN field
        const hiddenIsbnField = document.getElementById('editProductIsbn');
        if (hiddenIsbnField) {
            hiddenIsbnField.value = actualIsbn;
        }
        
        // Set basic fields with fallbacks and type checking
        const itemNameField = form.elements['item_name'];
        const skuField = form.elements['sku'];
        const isbnField = form.elements['isbn'];
        
        if (itemNameField) {
            itemNameField.value = productData['Item Name'] || productData.item_name || '';
        }
        
        if (skuField) {
            skuField.value = productData.sku || productData.SKU || '';
        }
        
        if (isbnField) {
            isbnField.value = actualIsbn;
        }
        
        // Set category and department with validation
        const category = productData['Category Dropdown'] || productData.category || '';
        const department = productData['Department Dropdown'] || productData.department || '';
        
        console.log('Setting category:', category, 'department:', department);
        
        // Set numeric fields with proper type conversion and validation
        const salesPrice = parseFloat(productData['Sales Price Includ Tax'] || productData.sales_price || 0);
        const vat = parseFloat(productData.Vat || productData.vat || 0);
        
        const salesPriceField = form.elements['sales_price'];
        const vatField = form.elements['vat'];
        
        if (salesPriceField) {
            salesPriceField.value = isNaN(salesPrice) ? '0.00' : salesPrice.toFixed(2);
        }
        
        if (vatField) {
            vatField.value = isNaN(vat) ? '0.00' : vat.toFixed(2);
        }
        
        // Set unit with validation
        const unit = productData['Sales Unit & Purch Unit'] || productData.unit || 'Quantity';
        const unitSelect = form.elements['unit'];
        
        if (unitSelect) {
            const unitOptions = Array.from(unitSelect.options).map(opt => opt.value);
            unitSelect.value = unitOptions.includes(unit) ? unit : 'Quantity';
        }
        
        // Set category and department values before initializing Select2
        const categoryField = form.elements['category'];
        const departmentField = form.elements['department'];
        
        if (categoryField) {
            categoryField.value = category;
        }
        
        if (departmentField) {
            departmentField.value = department;
        }
        
        // Initialize Select2 after setting values
        try {
            if (typeof $ !== 'undefined' && typeof $.fn.select2 === 'function') {
                // Destroy existing Select2 instances first
                $('.select2').each(function() {
                    if ($(this).data('select2')) {
                        $(this).select2('destroy');
                    }
                });
                
                // Initialize new Select2 instances
                $('.select2').select2({
                    theme: 'bootstrap4',
                    width: '100%',
                    dropdownParent: $('#editProductModal')
                });
                
                // Trigger change event to update display
                $('.select2').trigger('change');
            }
        } catch (select2Error) {
            console.warn('Error initializing Select2:', select2Error);
            // Select2 failed, but basic selects should still work
        }
        
        // Show the modal
        $('#editProductModal').modal('show');
        
        console.log('Edit modal opened successfully');
        
    } catch (error) {
        console.error('Error populating form:', error);
        console.error('Product data that caused error:', productData);
        
        Swal.fire({
            icon: 'error',
            title: 'Error Loading Product',
            html: `
                <p>There was an error loading the product data.</p>
                <p class="text-muted small">Error: ${error.message}</p>
                <p class="text-muted small">Please try again or contact support if the problem persists.</p>
            `,
            footer: 'Error details have been logged to the console'
        });
    }
}

// Enhanced debugging function to check product data structure
function debugProductData() {
    console.log('=== PRODUCT DATA DEBUG ===');
    console.log('Products array length:', products ? products.length : 'undefined');
    
    if (products && products.length > 0) {
        console.log('First product structure:', products[0]);
        console.log('Available keys in first product:', Object.keys(products[0] || {}));
        
        // Check for ISBN fields
        const isbnFields = [];
        products.forEach((product, index) => {
            if (product && (product.ISBN || product.isbn)) {
                isbnFields.push({
                    index: index,
                    ISBN: product.ISBN,
                    isbn: product.isbn,
                    name: product['Item Name'] || product.item_name
                });
            }
        });
        
        console.log('Products with ISBN fields:', isbnFields);
    }
    console.log('=== END DEBUG ===');
}

// Call debug function when page loads (remove in production)
document.addEventListener('DOMContentLoaded', function() {
    debugProductData();
});
   
    // Delete product with SweetAlert confirmation
    function deleteProduct(isbn, productName) {
        Swal.fire({
            title: 'Are you sure?',
            html: `You are about to delete:<br><strong>${productName}</strong><br><small>ISBN: ${isbn}</small>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '<i class="fas fa-trash"></i> Yes, delete it!',
            cancelButtonText: '<i class="fas fa-times"></i> Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                // Create and submit a form for deletion
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/delete_product/${isbn}`;
                document.body.appendChild(form);
                form.submit();
            }
        });
    }
    
    // Form submission handlers with SweetAlert
    document.getElementById('addProductForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        Swal.fire({
            title: 'Adding Product...',
            text: 'Please wait while we add the product',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        // Submit the form after a brief delay to show the loading
        setTimeout(() => {
            this.submit();
        }, 500);
    });
    
    document.getElementById('editProductForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        Swal.fire({
            title: 'Updating Product...',
            text: 'Please wait while we update the product',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        // Submit the form after a brief delay to show the loading
        setTimeout(() => {
            this.submit();
        }, 500);
    });
    
    // Success/Error messages (you can call these from your Flask routes)
    function showSuccessMessage(title, text) {
        Swal.fire({
            icon: 'success',
            title: title,
            text: text,
            timer: 2000,
            showConfirmButton: false
        });
    }
    
    function showErrorMessage(title, text) {
        Swal.fire({
            icon: 'error',
            title: title,
            text: text
        });
    }
    
    // Initialize Select2 for modals only
    $(document).ready(function() {
        // Initialize Select2 when modals are opened
        $('#addProductModal').on('shown.bs.modal', function () {
            $('.select2').select2({
                theme: 'bootstrap4',
                width: '100%',
                placeholder: 'Search...',
                allowClear: true,
                dropdownParent: $('#addProductModal')
            });
        });
    
        $('#editProductModal').on('shown.bs.modal', function () {
            $('.select2').select2({
                theme: 'bootstrap4',
                width: '100%',
                placeholder: 'Search...',
                allowClear: true,
                dropdownParent: $('#editProductModal')
            });
        });
    });

    // Add this function to handle modal cleanup
    function closeEditModal() {
        try {
            // Safely destroy Select2 instances
            if (typeof $.fn.select2 === 'function') {
                $('.select2').each(function() {
                    if ($(this).data('select2')) {
                        $(this).select2('destroy');
                    }
                });
            }
        } catch (error) {
            console.warn('Error cleaning up Select2:', error);
        }
        
        $('#editProductModal').modal('hide');
        document.getElementById('editProductForm').reset();
    }

    // Add event listener for modal hidden event
    $('#editProductModal').on('hidden.bs.modal', function () {
        closeEditModal();
    });
</script>
    
<style>
.swal2-popup {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.product-row:hover {
    background-color: #f8f9fa !important;
    transform: translateY(-1px);
    transition: all 0.2s ease;
}

.badge {
    font-size: 0.75em;
}

.btn-group .btn {
    margin: 0 2px;
}

.modal-header {
    border-bottom: none;
}

.modal-footer {
    border-top: none;
}

.form-group label {
    font-weight: 600;
    color: #495057;
}

.card-header {
    font-weight: 600;
}

.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.9em;
}

.fade-in {
    animation: fadeIn 0.3s ease-in;
}

/* Enhanced styling for the enlarged modal */
#editProductModal .modal-dialog {
    transition: all 0.3s ease;
}

#editProductModal .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    transform: scale(1.02);
    transition: all 0.2s ease;
}

#editProductModal .btn {
    transition: all 0.2s ease;
}

#editProductModal .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Responsive adjustments for smaller screens */
@media (max-width: 768px) {
    #editProductModal .modal-dialog {
        max-width: 95% !important;
        margin: 10px auto !important;
    }
    
    #editProductModal .modal-body {
        padding: 20px 15px !important;
    }
    
    #editProductModal .form-control {
        height: 45px !important;
        font-size: 0.9rem !important;
    }
    
    #editProductModal .modal-header,
    #editProductModal .modal-footer {
        padding: 20px 15px !important;
    }
}
</style>
{% endblock %}